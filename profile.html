<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Профиль - CodeLink</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <!-- Lucide Icons (если используете) -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
     <!-- CryptoJS для Gravatar -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <!-- Firebase Config -->
    <script>
        const firebaseConfig = {
             // !!! ЗАМЕНИТЕ НА ВАШ КОНФИГ !!!
            apiKey: "AIzaSyDGcQafcxrR3_8OE3Gs51nLYqVBRiavfTw",
            authDomain: "codelinked2347.firebaseapp.com",
            projectId: "codelinked2347",
            storageBucket: "codelinked2347.firebasestorage.app",
            messagingSenderId: "965987995013",
            appId: "1:965987995013:web:772c8889a527be574788ec"
        };
        firebase.initializeApp(firebaseConfig);
    </script>
</head>
<body>
    <div class="container">
        <!-- Mobile Menu Button -->
        <button class="mobile-menu-btn" id="mobileMenuBtn">
            <i class="fas fa-bars"></i>
        </button>
        <!-- Mobile Overlay -->
        <div class="mobile-overlay" id="mobileOverlay"></div>
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <span>Code</span><span>Link</span>
                </div>
            </div>
            <button class="new-post-btn" onclick="window.location.href='create.html'">
                <i class="fas fa-plus"></i>
                Новый пост
            </button>
            <nav class="nav-menu">
                <a href="index.html" class="nav-item">
                    <i class="fas fa-home"></i>
                    Главная
                </a>
                <a href="#" class="nav-item">
                    <i class="fas fa-fire"></i>
                    Популярное
                </a>
                <a href="#" class="nav-item">
                    <i class="fas fa-clock"></i>
                    Недавние
                </a>
            </nav>
            <div class="sidebar-footer">
                <p>CodeLink &copy; 2024</p>
                <p>Сообщество для разработчиков</p>
            </div>
        </aside>
        <!-- Main Content -->
        <main class="main-content">
            <header class="header">
                <div class="header-content">
                    <div class="search-container">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" class="search-input" placeholder="Поиск по постам...">
                    </div>
                    <div id="auth-buttons">
                        <a href="login.html" class="btn btn-outline">Войти</a>
                        <a href="register.html" class="btn btn-primary" style="margin-left: 8px;">Регистрация</a>
                    </div>
                    <div id="user-menu" style="display: none; align-items: center; gap: 12px;">
                        <img id="user-avatar-header" src="https://www.gravatar.com/avatar/00000000000000000000000000000000?d=mp&f=y" class="user-avatar" alt="User Avatar">
                        <span id="username-header">Пользователь</span>
                        <a href="profile.html" class="btn btn-outline">Профиль</a>
                        <button class="btn btn-outline" id="logout-btn">Выйти</button>
                    </div>
                </div>
            </header>
            <div class="profile-container" id="profile-container">
                <div class="profile-header">
                    <!-- Используем Gravatar -->
                    <img id="profile-avatar" src="https://www.gravatar.com/avatar/00000000000000000000000000000000?d=identicon&s=100" class="profile-avatar" alt="Profile Avatar">
                    <div class="profile-info">
                        <h1 class="profile-username" id="profile-username">Загрузка...</h1>
                        <p class="profile-email" id="profile-email"></p>
                        <!-- Кнопка ведет на Gravatar -->
                        <a href="https://ru.gravatar.com/connect/" target="_blank" rel="noopener noreferrer" class="change-avatar-btn">Изменить аватар на Gravatar</a>
                    </div>
                </div>
                <div class="profile-form">
                    <h2 class="card-title">Редактировать профиль</h2>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="profile-username-input" class="form-label">Имя пользователя</label>
                                <input type="text" id="profile-username-input" class="form-input" placeholder="Имя пользователя">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="profile-email-input" class="form-label">Email</label>
                                <input type="email" id="profile-email-input" class="form-input" placeholder="Email" disabled>
                            </div>
                        </div>
                    </div>
                    <div class="form-actions-profile">
                        <button class="btn btn-primary" id="save-profile-btn">Сохранить изменения</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Проверка авторизации
            firebase.auth().onAuthStateChanged(user => {
                if (!user) {
                    window.location.href = 'login.html';
                } else {
                    // Установка данных в шапке
                    const emailHashHeader = CryptoJS.MD5(user.email.toLowerCase().trim()).toString();
                    const gravatarUrlHeader = `https://www.gravatar.com/avatar/${emailHashHeader}?d=identicon&s=32`;
                    const avatarUrlHeader = user.photoURL || gravatarUrlHeader;
                    document.getElementById('user-avatar-header').src = avatarUrlHeader;
                    document.getElementById('username-header').textContent = user.displayName || user.email.split('@')[0];
                    document.getElementById('auth-buttons').style.display = 'none';
                    document.getElementById('user-menu').style.display = 'flex';
                    
                    // Загрузка данных профиля
                    loadProfile(user);
                }
            });

            document.getElementById('logout-btn').addEventListener('click', () => {
                firebase.auth().signOut();
            });

            // Сохранение профиля
            document.getElementById('save-profile-btn').addEventListener('click', saveProfile);
        });

        function loadProfile(user) {
            document.getElementById('profile-username').textContent = user.displayName || 'Пользователь';
            document.getElementById('profile-email').textContent = user.email;
            
            // Установка аватара в профиле (Gravatar)
            const emailHash = CryptoJS.MD5(user.email.toLowerCase().trim()).toString();
            const gravatarUrl = `https://www.gravatar.com/avatar/${emailHash}?d=identicon&s=100`;
            // const avatarUrl = user.photoURL || gravatarUrl; // Firebase photoURL не используется для Gravatar
            document.getElementById('profile-avatar').src = gravatarUrl; // Всегда показываем Gravatar
            
            document.getElementById('profile-username-input').value = user.displayName || '';
            document.getElementById('profile-email-input').value = user.email;
        }

        async function saveProfile() {
            const user = firebase.auth().currentUser;
            if (!user) return;

            const newUsername = document.getElementById('profile-username-input').value.trim();

            if (!newUsername) {
                alert('Имя пользователя не может быть пустым.');
                return;
            }

            try {
                await user.updateProfile({
                    displayName: newUsername
                    // photoURL не обновляется, так как используется Gravatar
                });
                document.getElementById('profile-username').textContent = newUsername;
                document.getElementById('username-header').textContent = newUsername;
                alert('Профиль успешно обновлен!');
            } catch (error) {
                console.error("Ошибка при обновлении профиля: ", error);
                alert('Ошибка при обновлении профиля: ' + error.message);
            }
        }
    </script>
</body>
</html>
