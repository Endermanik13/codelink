<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeLink - Сообщество для разработчиков</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <!-- Lucide Icons (если используете) -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <!-- CryptoJS для Gravatar -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <!-- Firebase Config -->
    <script>
        const firebaseConfig = {
            // !!! ЗАМЕНИТЕ НА ВАШ КОНФИГ !!!
            apiKey: "AIzaSyDGcQafcxrR3_8OE3Gs51nLYqVBRiavfTw",
            authDomain: "codelinked2347.firebaseapp.com",
            projectId: "codelinked2347",
            storageBucket: "codelinked2347.firebasestorage.app",
            messagingSenderId: "965987995013",
            appId: "1:965987995013:web:772c8889a527be574788ec"
        };
        firebase.initializeApp(firebaseConfig);
    </script>
</head>
<body>
    <div class="container">
        <!-- Mobile Menu Button -->
        <button class="mobile-menu-btn" id="mobileMenuBtn">
            <i class="fas fa-bars"></i>
        </button>
        <!-- Mobile Overlay -->
        <div class="mobile-overlay" id="mobileOverlay"></div>
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <span>Code</span><span>Link</span>
                </div>
            </div>
            <button class="new-post-btn" onclick="window.location.href='create.html'">
                <i class="fas fa-plus"></i>
                Новый пост
            </button>
            <nav class="nav-menu">
                <a href="index.html" class="nav-item active">
                    <i class="fas fa-home"></i>
                    Главная
                </a>
                <a href="#" class="nav-item">
                    <i class="fas fa-fire"></i>
                    Популярное
                </a>
                <a href="#" class="nav-item">
                    <i class="fas fa-clock"></i>
                    Недавние
                </a>
            </nav>
            <div class="sidebar-footer">
                <p>CodeLink &copy; 2024</p>
                <p>Сообщество для разработчиков</p>
            </div>
        </aside>
        <!-- Main Content -->
        <main class="main-content">
            <header class="header">
                <div class="header-content">
                    <div class="search-container">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" class="search-input" placeholder="Поиск по постам...">
                    </div>
                    <div id="auth-buttons">
                        <button class="new-post-btn" onclick="window.location.href='create.html'">
                            <i class="fas fa-plus"></i>
                            Новый пост
                        </button>
                        <a href="login.html" class="btn btn-outline" style="margin-left: 12px;">Войти</a>
                        <a href="register.html" class="btn btn-primary" style="margin-left: 8px;">Регистрация</a>
                    </div>
                    <div id="user-menu" style="display: none; align-items: center; gap: 12px;">
                        <!-- Используем Gravatar по умолчанию -->
                        <img id="user-avatar-header" src="https://www.gravatar.com/avatar/00000000000000000000000000000000?d=mp&f=y" class="user-avatar" alt="User Avatar">
                        <span id="username-header">Пользователь</span>
                        <a href="profile.html" class="btn btn-outline">Профиль</a>
                        <button class="btn btn-outline" id="logout-btn">Выйти</button>
                    </div>
                </div>
            </header>
            <div class="posts-feed" id="posts-feed">
                <!-- Посты будут загружаться сюда -->
                <div class="empty-feed">Загрузка постов...</div>
            </div>
        </main>
    </div>

    <script src="script.js"></script>
    <script>
        // Проверка авторизации и загрузка постов
        document.addEventListener('DOMContentLoaded', function () {
            const authButtons = document.getElementById('auth-buttons');
            const userMenu = document.getElementById('user-menu');
            const usernameHeader = document.getElementById('username-header');
            const userAvatarHeader = document.getElementById('user-avatar-header');
            const logoutBtn = document.getElementById('logout-btn');
            const postsFeed = document.getElementById('posts-feed');

            // Проверка состояния аутентификации
            firebase.auth().onAuthStateChanged(user => {
                if (user) {
                    authButtons.style.display = 'none';
                    userMenu.style.display = 'flex';
                    
                    // Установка имени пользователя
                    usernameHeader.textContent = user.displayName || user.email.split('@')[0];
                    
                    // Установка аватара (Gravatar по умолчанию)
                    const emailHash = CryptoJS.MD5(user.email.toLowerCase().trim()).toString();
                    const gravatarUrl = `https://www.gravatar.com/avatar/${emailHash}?d=identicon&s=32`;
                    const avatarUrl = user.photoURL || gravatarUrl;
                    userAvatarHeader.src = avatarUrl;
                    
                    loadPosts(); // Загрузка постов после входа
                } else {
                    authButtons.style.display = 'flex';
                    userMenu.style.display = 'none';
                    postsFeed.innerHTML = '<div class="empty-feed">Войдите, чтобы видеть посты.</div>';
                }
            });

            // Выход
            if (logoutBtn) {
                logoutBtn.addEventListener('click', () => {
                    firebase.auth().signOut();
                });
            }

            // Загрузка постов
            async function loadPosts() {
                try {
                    const querySnapshot = await firebase.firestore().collection('posts')
                        .orderBy('timestamp', 'desc')
                        .limit(20)
                        .get();

                    if (querySnapshot.empty) {
                        postsFeed.innerHTML = '<div class="empty-feed">Пока нет постов. Будьте первым!</div>';
                        return;
                    }

                    let postsHtml = '';
                    const currentUser = firebase.auth().currentUser;
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        const postId = doc.id;
                        const timeAgo = window.formatTimeAgo(data.timestamp);
                        const excerpt = data.content.length > 200 ? data.content.substring(0, 200) + '...' : data.content;
                        const tagsHtml = (data.tags || []).map(tag => `<a href="#" class="tag">${tag}</a>`).join(' ');

                        // Аватар автора поста (Gravatar по умолчанию)
                        const authorEmailHash = data.authorEmail ? CryptoJS.MD5(data.authorEmail.toLowerCase().trim()).toString() : '00000000000000000000000000000000';
                        const authorGravatarUrl = `https://www.gravatar.com/avatar/${authorEmailHash}?d=identicon&s=40`;
                        const authorAvatarUrl = data.avatar || authorGravatarUrl;

                        // Проверка, является ли текущий пользователь автором поста
                        const isAuthor = currentUser && currentUser.uid === data.uid;
                        const deleteButtonHtml = isAuthor ? `<button class="post-delete-btn" data-id="${postId}"><i class="fas fa-trash"></i> Удалить</button>` : '';

                        postsHtml += `
                        <article class="post-card" data-id="${postId}">
                            <div class="post-header">
                                <img src="${authorAvatarUrl}" 
                                     alt="${data.username}" class="post-avatar">
                                <div class="post-user-info">
                                    <div class="post-username">${data.username || 'Аноним'}</div>
                                    <div class="post-meta">${timeAgo}</div>
                                </div>
                                ${deleteButtonHtml}
                            </div>
                            <h2 class="post-title"><a href="post.html?id=${postId}">${data.title || 'Без заголовка'}</a></h2>
                            <div class="post-excerpt">${excerpt}</div>
                            <div class="post-footer">
                                <div class="post-tags">
                                    ${tagsHtml}
                                </div>
                                <div class="post-stats">
                                    <div class="post-stat">
                                        <i class="fas fa-heart"></i>
                                        <span>${data.likes ? data.likes.length : 0}</span>
                                    </div>
                                    <div class="post-stat">
                                        <i class="fas fa-comment"></i>
                                        <span>${data.comments ? data.comments.length : 0}</span>
                                    </div>
                                </div>
                            </div>
                        </article>
                        `;
                    });

                    postsFeed.innerHTML = postsHtml;

                    // Добавляем обработчики событий для кнопок удаления
                    document.querySelectorAll('.post-delete-btn').forEach(button => {
                        button.addEventListener('click', async (e) => {
                            e.preventDefault();
                            const postId = button.getAttribute('data-id');
                            if (confirm('Вы уверены, что хотите удалить этот пост?')) {
                                try {
                                    await firebase.firestore().collection('posts').doc(postId).delete();
                                    // Перезагружаем посты после удаления
                                    loadPosts();
                                } catch (error) {
                                    console.error("Ошибка при удалении поста: ", error);
                                    alert('Ошибка при удалении поста.');
                                }
                            }
                        });
                    });

                } catch (error) {
                    console.error("Ошибка загрузки постов: ", error);
                    postsFeed.innerHTML = '<div class="empty-feed">Ошибка загрузки постов.</div>';
                }
            }
        });
    </script>
</body>
</html>
